name: CD - Publish Package

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  id-token: write # Required for authentication with pub.dev via OIDC

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: "endsWith(github.event.head_commit.message, '[release]') || github.event_name == 'workflow_dispatch'"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.10.1'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: flutter pub get

      - name: Generate Release Notes
        run: |
          # Find the previous commit that had [release] in the message
          LAST_RELEASE_SHA=$(git log --format="%H" --grep="\[release\]" --skip=1 -n 1)

          if [ -z "$LAST_RELEASE_SHA" ]; then
            echo "No previous release found, generating log from start."
            git log --pretty=format:"- %s" > release_notes.txt
          else
            echo "Generating log from $LAST_RELEASE_SHA to HEAD"
            git log --pretty=format:"- %s" $LAST_RELEASE_SHA..HEAD > release_notes.txt
          fi
          
          echo "Release Notes Content:"
          cat release_notes.txt

      - name: Auto-Bump Version
        id: bump
        run: |
          # Create a Dart script to handle the smart version bumping
          cat <<EOF > bump_version.dart
          import 'dart:io';
          import 'dart:convert';

          void main() async {
            // 1. Read local pubspec.yaml
            final pubspecFile = File('pubspec.yaml');
            final lines = await pubspecFile.readAsLines();
            String? name;
            String? localVersionStr;
            
            for (var line in lines) {
              if (line.trim().startsWith('name:')) {
                name = line.split(':')[1].trim();
              } else if (line.trim().startsWith('version:')) {
                localVersionStr = line.split(':')[1].trim();
              }
            }

            if (name == null || localVersionStr == null) {
              print('Error: Could not find name or version in pubspec.yaml');
              exit(1);
            }

            print('Package: \$name');
            print('Local Version: \$localVersionStr');

            // 2. Fetch latest version from pub.dev
            String? publishedVersionStr;
            try {
              final url = Uri.parse('https://pub.dev/api/packages/\$name');
              final request = await HttpClient().getUrl(url);
              final response = await request.close();
              if (response.statusCode == 200) {
                final body = await response.transform(utf8.decoder).join();
                final json = jsonDecode(body);
                publishedVersionStr = json['latest']['version'];
                print('Published Version: \$publishedVersionStr');
              } else {
                print('Package not found on pub.dev or API error (Status \${response.statusCode}). Assuming first release.');
              }
            } catch (e) {
              print('Error checking pub.dev: \$e');
            }

            // 3. Determine Next Version
            String nextVersion = localVersionStr!;
            if (publishedVersionStr != null) {
              final local = _parseVersion(localVersionStr);
              final published = _parseVersion(publishedVersionStr);

              if (_isGreater(published, local) || _isEqual(published, local)) {
                // If published is >= local, we must bump published to get next
                // Defaulting to patch bump
                nextVersion = '\${published[0]}.\${published[1]}.\${published[2] + 1}';
                print('Published version >= Local version. Bumping to \$nextVersion');
              } else {
                print('Local version is already ahead. Using \$nextVersion');
              }
            }

            // 4. Update pubspec.yaml
            final newLines = lines.map((line) {
              if (line.trim().startsWith('version:')) {
                return 'version: \$nextVersion';
              }
              return line;
            }).toList();
            
            await pubspecFile.writeAsString(newLines.join('\n') + '\n');
            
            // Output for GitHub Actions
            File(Platform.environment['GITHUB_ENV']!).writeAsStringSync('NEW_VERSION=\$nextVersion\n', mode: FileMode.append);
          }

          List<int> _parseVersion(String v) {
            return v.split('+')[0].split('.').map(int.parse).toList();
          }

          bool _isGreater(List<int> a, List<int> b) {
            if (a[0] > b[0]) return true;
            if (a[0] < b[0]) return false;
            if (a[1] > b[1]) return true;
            if (a[1] < b[1]) return false;
            return a[2] > b[2];
          }

          bool _isEqual(List<int> a, List<int> b) {
             return a[0] == b[0] && a[1] == b[1] && a[2] == b[2];
          }
          EOF

          # Run the script
          dart run bump_version.dart

          # Commit the change
          NEW_VERSION=${{ env.NEW_VERSION }} # This var might not be available yet in this step block, relying on script writing to env
          # We need to reload the env or just read it from the file we just wrote? 
          # Actually, 'dart run' will finish, then we can read the env var in the NEXT step or rely on git diff.
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add pubspec.yaml
          
          # Only commit if there are changes
          if ! git diff-index --quiet HEAD; then
            git commit -m "chore: bump version to ${{ env.NEW_VERSION }}" # env context is evaluated at start of step. This won't work within same step!
            # Fix: Read from grep since env update applies to subsequent steps
            CURRENT_VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //')
            git commit -m "chore: bump version to $CURRENT_VERSION"
            git tag "v$CURRENT_VERSION"
            git push origin main --follow-tags
          else
             echo "No version change needed."
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.NEW_VERSION }}
          name: v${{ env.NEW_VERSION }}
          body_path: release_notes.txt

      - name: Setup Dart for OIDC
        uses: dart-lang/setup-dart@v1

      - name: Publish to pub.dev
        run: dart pub publish --force
